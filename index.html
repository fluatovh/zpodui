<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zPod Factory - zPod Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Burger menu -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>üöÄ zPod Factory</h2>
            <button class="sidebar-close" id="closeSidebar">&times;</button>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-page="zpods">
                <span class="nav-icon">üì¶</span>
                <span class="nav-text">zPods</span>
            </a>
            <a href="#" class="nav-item" data-page="profiles">
                <span class="nav-icon">üìã</span>
                <span class="nav-text">Profiles</span>
            </a>
            <a href="#" class="nav-item" data-page="components">
                <span class="nav-icon">üß©</span>
                <span class="nav-text">Components</span>
            </a>
            <a href="#" class="nav-item" data-page="endpoints">
                <span class="nav-icon">üîó</span>
                <span class="nav-text">Endpoints</span>
            </a>
            <a href="#" class="nav-item" data-page="libraries">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Libraries</span>
            </a>
            <a href="#" id="dashboardLink" class="nav-item nav-item-external" target="_blank" rel="noopener noreferrer">
                <span class="nav-icon">üêç</span>
                <span class="nav-text">Prefect Dashboard</span>
                <span class="nav-external-icon">‚ÜóÔ∏è</span>
            </a>
        </nav>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <header>
            <div class="header-content">
                <button id="menuToggle" class="menu-toggle" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div>
                    <h1 id="pageTitle">üöÄ zPod Factory</h1>
                    <p class="subtitle" id="pageSubtitle">zPod Manager</p>
                </div>
                <div class="header-actions">
                    <button id="configBtn" class="btn-icon" aria-label="Configuration" title="Configuration">
                        <span>‚öôÔ∏è</span>
                    </button>
                    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                        <span class="theme-icon" id="themeIcon">üåô</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Profile details modal -->
        <div id="profileDetailModal" class="modal hidden">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2 id="profileDetailTitle">üìã Profile Details</h2>
                    <button class="modal-close" id="closeProfileDetailModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="profileDetailContent">
                        <!-- Component details will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add DNS modal -->
        <div id="addDnsModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚ûï Add DNS Entry</h2>
                    <button class="modal-close" id="closeAddDnsModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addDnsForm">
                        <div class="form-group">
                            <label for="dnsHostname">Hostname</label>
                            <input 
                                type="text" 
                                id="dnsHostname" 
                                placeholder="ex: myserver"
                                required
                            />
                            <small>Host name (without domain)</small>
                        </div>
                        <div class="form-group">
                            <label for="dnsIp">IP Address</label>
                            <input 
                                type="text" 
                                id="dnsIp" 
                                placeholder="ex: 172.16.1.100"
                                required
                                pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                            />
                            <small>IPv4 address (ex: 172.16.1.100)</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelAddDnsBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Success modal after component add/delete -->
        <div id="componentSuccessModal" class="modal hidden">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2 id="componentSuccessTitle">‚úÖ Component added successfully!</h2>
                </div>
                <div class="modal-body">
                    <p id="componentSuccessMessage" style="text-align: center; margin-bottom: 24px; color: var(--text-secondary);">
                        The component has been added to the zPod successfully.
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="goToDashboardBtn" class="btn btn-primary" style="flex: 1;">
                            <span>üìä</span> Prefect Dashboard
                        </button>
                        <button id="stayOnPageBtn" class="btn btn-secondary" style="flex: 1;">
                            <span>üì¶</span> Stay on page
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success modal after zPod creation -->
        <div id="zpodSuccessModal" class="modal hidden">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>‚úÖ zPod created successfully!</h2>
                </div>
                <div class="modal-body">
                    <p style="text-align: center; margin-bottom: 24px; color: var(--text-secondary);">
                        The zPod has been created successfully.
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="goToDashboardZpodBtn" class="btn btn-primary" style="flex: 1;">
                            <span>üìä</span> Prefect Dashboard
                        </button>
                        <button id="stayOnZpodPageBtn" class="btn btn-secondary" style="flex: 1;">
                            <span>üì¶</span> Stay on page
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add zPod modal -->
        <div id="addZpodModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚ûï Create a new zPod</h2>
                    <button class="modal-close" id="closeAddZpodModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addZpodForm">
                        <div class="form-group">
                            <label for="zpodName">zPod Name</label>
                            <input 
                                type="text" 
                                id="zpodName" 
                                placeholder="ex: my-zpod"
                                required
                            />
                            <small>Unique name to identify the zPod</small>
                        </div>
                        <div class="form-group">
                            <label for="zpodProfile">Profile</label>
                            <select id="zpodProfile" required>
                                <option value="">Select a profile...</option>
                            </select>
                            <small>Configuration profile for the zPod</small>
                        </div>
                        <div class="form-group">
                            <label for="zpodEndpoint">Endpoint</label>
                            <select id="zpodEndpoint" required>
                                <option value="">Select an endpoint...</option>
                            </select>
                            <small>Endpoint where to deploy the zPod</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelAddZpodBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add component modal -->
        <div id="addComponentModal" class="modal hidden">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>‚ûï Add a component</h2>
                    <button class="modal-close" id="closeAddComponentModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addComponentForm">
                        <div class="form-group">
                            <label for="componentUid">Component</label>
                            <select id="componentUid" required>
                                <option value="">Select a component...</option>
                            </select>
                            <small>Active component to add to the zPod</small>
                        </div>
                        <div class="form-group">
                            <label for="componentHostname">Hostname</label>
                            <input 
                                type="text" 
                                id="componentHostname" 
                                placeholder="ex: esxi13"
                            />
                            <small>Host name (optional)</small>
                        </div>
                        <div class="form-group">
                            <label for="componentIpLastOctet">IP Last Octet</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="componentIpPrefix" style="font-family: 'Courier New', monospace; font-weight: 600;">172.16.0.</span>
                                <input 
                                    type="number" 
                                    id="componentIpLastOctet" 
                                    placeholder="ex: 13"
                                    min="1"
                                    max="254"
                                    required
                                />
                            </div>
                            <small>Last octet of the IP address (1-254). The first 3 octets come from the management network.</small>
                        </div>
                        <div class="form-group">
                            <label for="componentVcpu">vCPU</label>
                            <input 
                                type="number" 
                                id="componentVcpu" 
                                placeholder="ex: 4"
                                min="1"
                            />
                            <small>Number of vCPU (optional)</small>
                        </div>
                        <div class="form-group">
                            <label for="componentVmem">vMem (GB)</label>
                            <input 
                                type="number" 
                                id="componentVmem" 
                                placeholder="ex: 16"
                                min="1"
                            />
                            <small>Amount of RAM in GB (optional)</small>
                        </div>
                        <div class="form-group" id="componentDisksGroup" style="display: none;">
                            <label>Disks (up to 15)</label>
                            <div id="componentDisksContainer">
                                <div class="disk-input-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                    <input 
                                        type="number" 
                                        class="disk-size-input" 
                                        placeholder="Size in GB"
                                        min="1"
                                        style="flex: 1;"
                                    />
                                    <button type="button" class="btn-remove-disk" style="background: #ef4444; color: white; border: none; border-radius: 4px; width: 32px; height: 32px; cursor: pointer; display: none;">√ó</button>
                                </div>
                            </div>
                            <button type="button" id="addDiskBtn" class="btn btn-secondary" style="margin-top: 8px;">+ Add a disk</button>
                            <small>Disk sizes in GB (optional, up to 15 disks)</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelAddComponentBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Configuration modal -->
        <div id="configModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è API Configuration</h2>
                    <button class="modal-close" id="closeConfigModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <div class="form-group">
                            <label for="apiEndpoint">API Endpoint</label>
                            <input 
                                type="text" 
                                id="apiEndpoint" 
                                placeholder="http://example.com:8000"
                                required
                            />
                            <small>Base URL of the zPod Factory API</small>
                        </div>
                        <div class="form-group">
                            <label for="apiToken">Access Token</label>
                            <input 
                                type="password" 
                                id="apiToken" 
                                placeholder="Leave empty to keep current token"
                            />
                            <small>Authentication token for the API. Leave empty to keep the current token.</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelConfig">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p id="loadingText">Loading...</p>
        </div>

        <div id="error" class="error hidden"></div>

        <!-- zPods Page -->
        <div id="page-zpods" class="page-content">
            <div class="controls">
                <div class="search-filter">
                    <input type="text" id="zpodSearchFilter" class="search-input" placeholder="üîç Search for a zPod by name..." />
                </div>
                <button id="addZpodBtn" class="btn btn-success" style="background: var(--success-color);">
                    <span class="icon">+</span>
                    Add a zPod
                </button>
                <button id="refreshBtn" class="btn btn-primary">
                    <span class="icon">üîÑ</span>
                    Refresh
                </button>
                <div class="status-indicator" id="statusIndicator">
                    <span class="status-dot"></span>
                    <span id="statusText">Ready</span>
                </div>
            </div>
            <div id="zpodsContainer" class="zpods-container">
                <!-- zPods will be displayed here -->
            </div>
        </div>

        <!-- zPod Detail Page -->
        <div id="page-zpod-detail" class="page-content hidden">
            <div class="controls">
                <button id="backToZpodsBtn" class="btn btn-secondary">
                    <span class="icon">‚Üê</span>
                    Back to zPods
                </button>
                <button id="refreshZpodDetailBtn" class="btn btn-primary">
                    <span class="icon">üîÑ</span>
                    Refresh
                </button>
                <button id="deleteZpodBtn" class="btn btn-danger" style="background: #ef4444; color: white;">
                    <span class="icon">üóëÔ∏è</span>
                    Delete zPod
                </button>
            </div>
            <div id="zpodDetailContainer" class="zpod-detail-container">
                <!-- zPod details will be displayed here -->
            </div>
        </div>

        <!-- Profiles Page -->
        <div id="page-profiles" class="page-content hidden">
            <div class="controls">
                <button id="refreshProfilesBtn" class="btn btn-primary">
                    <span class="icon">üîÑ</span>
                    Refresh
                </button>
            </div>
            <div id="profilesContainer" class="cards-container">
                <!-- Profiles will be displayed here -->
            </div>
        </div>

        <!-- Components Page -->
        <div id="page-components" class="page-content hidden">
            <div class="controls">
                <div class="filter-group">
                    <label for="componentFilter" class="filter-label">Filter by status:</label>
                    <select id="componentFilter" class="filter-select">
                        <option value="all">All</option>
                        <option value="ACTIVE" selected>Active</option>
                        <option value="INACTIVE">Inactive</option>
                    </select>
                </div>
                <button id="refreshComponentsBtn" class="btn btn-primary">
                    <span class="icon">üîÑ</span>
                    Refresh
                </button>
            </div>
            <div id="componentsContainer" class="cards-container">
                <!-- Components will be displayed here -->
            </div>
        </div>

        <!-- Endpoints Page -->
        <div id="page-endpoints" class="page-content hidden">
            <div class="controls">
                <button id="refreshEndpointsBtn" class="btn btn-primary">
                    <span class="icon">üîÑ</span>
                    Refresh
                </button>
            </div>
            <div id="endpointsContainer" class="cards-container">
                <!-- Endpoints will be displayed here -->
            </div>
        </div>

        <!-- Libraries Page -->
        <div id="page-libraries" class="page-content hidden">
            <div class="controls">
                <button id="refreshLibrariesBtn" class="btn btn-primary">
                    <span class="icon">üîÑ</span>
                    Refresh
                </button>
            </div>
            <div id="librariesContainer" class="cards-container">
                <!-- Libraries will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration check - only from config.js (no localStorage)
        (function() {
            // Load config.js and check its content
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onerror = function() {
                // config.js doesn't exist - redirect immediately
                console.warn('config.js not found, redirecting to configuration');
                window.location.replace('/proxy.php?action=configure');
            };
            script.onload = function() {
                // config.js loaded, check its content
                setTimeout(function() {
                    // Only check endpoint (token is server-side only)
                    const hasConfig = typeof window.ZPODFACTORY_CONFIG !== 'undefined' &&
                                     window.ZPODFACTORY_CONFIG &&
                                     window.ZPODFACTORY_CONFIG.apiEndpoint &&
                                     window.ZPODFACTORY_CONFIG.apiEndpoint.trim() !== '';
                    
                    if (!hasConfig) {
                        console.log('config.js exists but is incomplete, redirecting');
                        window.location.replace('/proxy.php?action=configure');
                    } else {
                        // Load app.js
                        const appScript = document.createElement('script');
                        appScript.src = 'app.js';
                        document.body.appendChild(appScript);
                    }
                }, 10);
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>

